# Сервис payconsul

[Роман Опякин](https://t.me/sinketsu)

### Agenda
Сервис изначально задумывался как "аналог" [Hashicorp Consul](https://www.consul.io/)
Реализована функциональность `key-value` хранилища, регистрации/дерегистрации сервисов в каталоге, а также управление хэлсчеками.
Также по легенде чуваки запилили новую версию и выкатили ее под балансер. Туда попадает 20% траффика пользователей (управляется кукой).
   
#### Чекер
Чекер проверяет:
1. Экспорт метрик (по `promhttp_metric_handler_requests_total{code="200"}`)
2. Что проставляется кука с апстримом (`upid`)
3. Что по куке попадаешь в разные апстримы
4. Что можно зарегать сервис
5. Что можно поставить хэлсчек сервису
6. Что нельзя зарегать одного юзера/один сервис дважды
7. Что нельзя дерегистрировать чужой сервис
8. Что работает `key-value` хранилище
9. Что можно дерегистрировать сервис

Чекер кладет флаги в разные места:
* `key-value` хранилище с вероятностью 25%
* в поле `meta` сервиса с вероятностью 75%
